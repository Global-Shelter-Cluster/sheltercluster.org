<?php
/**
 * @file
 * Code for the cluster_docs feature.
 */

include_once 'cluster_docs.features.inc';

const CLUSTER_DOCS_PER_PAGE = 5;

/**
 *  Implements hook_menu().
 */
function cluster_docs_menu() {
  $items['node/%/documents'] = array(
    'title' => 'Documents',
    'page callback' => 'cluster_docs_all',
    'page arguments' => array(1),
    'access callback' => 'og_is_group',
    'access arguments' => array(0, 1),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

function cluster_docs_all($nid) {
  global $language;
  $query = search_api_query('default_node_index', array(
    'languages' => array($language->language),
  ));

  $filter = $query->createFilter();
  $filter->condition('og_group_ref', $nid);
  $filter->condition('type', 'document');
  $query->filter($filter);

  $offset = pager_find_page() * CLUSTER_DOCS_PER_PAGE;
  $query->range($offset, CLUSTER_DOCS_PER_PAGE);

  $results = $query->execute();

  pager_default_initialize($results['result count'], CLUSTER_DOCS_PER_PAGE);

  $nids = array_keys($results['results']);

  $ret = GroupPageContent::getList($nids, 'teaser', 'cluster_docs_all');
  $ret['pager'] = array(
    '#theme' => 'pager',
  );

  return $ret;
}

/**
 * Implements hook_theme().
 */
function cluster_docs_theme() {
  return array(
    'cluster_docs_all' => array(
      'file' => 'theme/cluster_docs.theme.inc',
      'render element' => 'element',
    ),
  );
}
